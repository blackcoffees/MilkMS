<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cy.milkms.db.dao.ReportMapper">
	<resultMap id="reportTotalNumberMap" type="com.cy.milkms.db.query.ReportTotalNumberQuery">
		<result column="milkID" property="milkID"  jdbcType="INTEGER"/>
		<result column="milkName" property="milkName"  jdbcType="VARCHAR"/>
		<result column="milkTotalNumber" property="milkTotalNumber"  jdbcType="INTEGER"/>
		<result column="milkTotalPrice" property="milkTotalPrice"  jdbcType="DOUBLE"/>
	</resultMap>
	
	<resultMap id="reportPurchaseTableQueryMap" type="com.cy.milkms.db.query.ReportPurchaseTableQuery" extends="com.cy.milkms.db.dao.PurchaseMapper.totalPurchaseQueryMap">
		<result column="totalNumber" property="totalNumber"  jdbcType="INTEGER"/>
		<result column="totalPrice" property="totalPrice"  jdbcType="DOUBLE" />
	</resultMap>
	
	<select id="getPurchaseReportTotalNumber" resultMap="reportTotalNumberMap">
		select 
			detailed.id,milk.milk_name as milkName, sum(detailed.number) as milkTotalNumber, sum(detailed.total_amount) as milkTotalPrice
		from purchase, purchase_detailed as detailed, milk
		where
			purchase.id = detailed.purchase_id and detailed.milk_id = milk.id 
			and purchase.status = 1
			<if test="startTime != null and startTime != ''">
				and #{startTime} &gt; time
			</if>
			<if test="endTime != null and endTime != ''">
				and #{endTime} &lt; time
			</if>
		group by detailed.milk_id
		order by milkTotalPrice desc
	</select>
	
	<select id="getPurchaseReportLimit" resultMap="reportPurchaseTableQueryMap">
		SELECT
			milk.milk_name as name,
			purchase.id,
			purchase.time,
			detailed.number,
			detailed.purchase_price,
			detailed.total_amount
		from purchase, purchase_detailed as detailed, milk
		where
			purchase.id = detailed.purchase_id and milk.id = detailed.milk_id
			and purchase.status = 1
			<if test="startTime != null and startTime != ''">
				and #{startTime} &gt; time
			</if>
			<if test="endTime != null and endTime != ''">
				and #{endTime} &lt; time
			</if>
			AND detailed.milk_id IN (
				SELECT
					t.milk_id
				FROM
					(
						SELECT DISTINCT
							milk_id,
							SUM(total_amount) AS t_total_amount
						FROM
							purchase_detailed
						GROUP BY
							milk_id
						ORDER BY
							t_total_amount DESC
						LIMIT #{pager.start}, #{pager.rows}
					) AS t
			)
	</select>
</mapper>